var pkgcloud = require('pkgcloud');
var recursive = require('recursive-readdir');
var fs = require('fs');
var async = require("async");


var cloudfiles = pkgcloud.storage.createClient({
   provider: 'rackspace',
   username: 'openlearning.activityblocks',
   apiKey: 'b7da842b6b7f4e879f706a59e0064acd',
   region: 'SYD'
});


function getFiles(tmpDirName,callback){
	recursive(tmpDirName, function (err, files) {
  		// Files is an array of filename
  		if(!err)
  			callback(files) 
  		else
  			console.log("Error in get Files ",err)
	});

};

function getRemoteName(fileName,tmpDirName,appName){
	return fileName.replace(tmpDirName,appName)
};


function uploadCDN(remoteURL,actualURL,clb){
	var readStream = fs.createReadStream(actualURL);

	var writeStream = cloudfiles.upload({
    	container: 'test-openlearning.io',
    	remote: remoteURL
 	});

 	writeStream.on('error', function(err) {
    	// handle your error case
    	console.log("error has occured while uploding the file ",err)
      clb("error", 'error');
 	});

 	writeStream.on('success', function(file) {
    // success, file will be a File model
    	console.log(file.name," is successfully uploded")
      clb(null, 'success');
 	});	
 	readStream.pipe(writeStream);
};




// Function to upload files to CDN
// tmepDirName is where we have extracted tar file which is been released by user 
// appName is Application name + version 
function upload(tmpDirName, appName, callback){
	// Search files recursively 
  
	getFiles(tmpDirName, function(files) {
			// its list of files from which need to extract /tmp and then release convention name
      /*
			for (var i = 0; i < files.length; i++) { 
				var remote = getRemoteName(files[i],tmpDirName,appName);
        console.log("Calling upload cdn")
				uploadCDN(remote,files[i]);				
			};
      callback(null,tmpDirName);
      */
      
      var asyncTasks = [];

      files.forEach(function(file) {
        var remote = getRemoteName(file, tmpDirName, appName);
        var delegate = function(fileCB) {
          uploadCDN(remote, file, fileCB);
        };

        asyncTasks.push(delegate);
      });

      async.parallel(asyncTasks, function(err, results){
         // All tasks are done now
        if (err){
          // Need to decide if we fail to upload the files 
        }
        callback(null,tmpDirName);
      });
      
      
  });
};



module.exports = {
  'upload': upload
};
